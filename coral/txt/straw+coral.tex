\documentclass[a4paper,12pt]{article}
    \input epsf
    \author{Alexander Zvyagin}
    \title{STRAW+CORAL test}
    \date{January 2006}

\begin{document}
\maketitle

    \begin{abstract}
        How to create an automatic report to test straw tubes detector
        performance in a framework of the COMPASS reconstruction program.
        %The pictures description of the report is given as well.
    \end{abstract}

\tableofcontents

\section{Introduction}
A perfect detector hardware performance will not be seen without an adequate
software support. And without a working detector any software is useless.
Doing {\bf STDC} analysis in the {\bf CORAL+PHAST} framework we are sensitive
to
\begin{itemize}
\item performance of the {\bf CORAL} software (because we use {\bf CORAL}
tracks to expose the {\bf STDC} planes and without a good ones our results
are meaningless);
\item software description of {\bf STDC};
\item hardware performace of {\bf STDC}.
\end{itemize}
In the present document it is described how to perform a such analysis and
understand its results.

The document starts from a terminology section. Then a major plan in the
analysis is presented. A detailed description of the {\it how-to-do} process
is given next. And finaly it is described the pictures made by an automatic
report producer.

\section{Terminology}
\begin{description}
\item[COMPASS] It is the name of our experiment.
\item[CORAL] COMPASS reconstruction program.
\item[PHAST] COMPASS data analysis framework.
\item[CORAL+PHAST] Program with both {\bf CORAL} and {\bf PHAST} features.
\item[ROOT] Software designed for data analysis (see {\it http://root.cern.ch}).
\item[mDST] Micro-DST root file, output of the {\bf PHAST} program.
\item[DST] Data Summary Tape - a historical name for a collection of
      reconstructed events from an experiment in high energy physics.
\item[STDC] Straw Tubes Drift Chamber.
\item[DC] Saclay drift chamber.
\item[W45] Huge drift chamber with a strange name W45.
\item[Spacer] Small piece of plastic (approximately $3 \times 10 mm^2$) to hold a wire
      in tube center.
\item[Xray] X-ray setup to scan the geometry of {\bf STDC} to determinate
        the position of all spacers.
\item[Xray corrections] Results of a Xray scan. These are mainly
        (x,y) coordinates of the spacers.
\item[DL] Double Layer - one {\bf STDC} physical detector. Physycally it is
        constracted from a two layers. A single layer is divided to 3 parts,
        so totally one physical {\bf STDC} detector consists of 6 smaller
        detectors.
\item[Layer] One half of a DL. Single layer consists of two 10mm
        straw tubes sections and one 6mm straw tubes section.
\item[Section] One of a two 10mm straw tubes parts or a 6mm part of
        a layer. A section name has a form {\bf ST05X1db}. The first two
        letters are always {\bf ST} - they inidcate that this is a {\bf STDC}
        detector. The next number {\bf 05} is a {\bf STDC} station number.
        Next letter {\bf X} indicates the section projection angle. There are four
        possible orientations: X,U,V,Y. After the projection letter it goes number
        {\bf 1} - the counter of sections with the same projection in a given station.
        This number is usually always 1, and in a few cases it goes to 2.
        The letter {\bf d} identifies one of the two layers - it stands for an
        {\bf u}pstream or a {\bf d}ownstream layer. The very last letter {\bf b}
        says that the section
        consists of 6mm straw tubes. For the 10mm straw tubes the letter would have been
        {\bf a} or {\bf c}.
\item[Smooth point] The term is used in tracking. When a track is fitted and its parameters
        are known, you may calculate track parameters at any point along the track. But this can
        be done with a better precison if you tell to the tracking algorithm in advance that you want
        to know the track parameters at a specfic position. This position is called {\it smoothing point}.
\item[detectors.dat or detectors-dat file] COMPASS geometry description used by {\bf CORAL}.
\item[CVS] Version control system - tracker of a source code modifications.
\item[CASTOR] Storage file system for a big volumes at CERN.
\item[residual] Spatial distance between a reconstructed track and a wire $\pm$ drift distance.
      If $t$ is a track coordinate, $w$ is a wire position and $d$ is a drift distance, then
      $$residual = \left\{
        \begin{array}{ll}
            t-(w+d) & \mbox{if  } |t-(w+d)|<|t-(w-d))| \\
            t-(w-d) & \mbox{if  } |t-(w+d)|\geq|t-(w-d))|
        \end{array}
        \right.
      $$
      Briefly speaking, residual is a shortest distance between track and wire $\pm$ drift distance.
\item[Albert's plots] The set of plots from Albert Lehman used for plotting the {\bf CORAL} residuals.
\item[MRS] Master Reference System of the COMPASS experiment. Y-axis goes from bottom to top.
         Z-axis is in the direction of beam. X-axis is from Saleve to Jura.
\item[DRS] Detector Reference System. In DRS all wires (of {\bf STDC} tubes) are positioned along Y-axis.
         Z-coordinate is 0 (so DRS has dimensions). Please note that this definition of detector 
         reference system differs from the one given by {\bf CORAL} and it is equivalent to the {\bf CORAL}' wire 
         reference system definition.
\item[Ntuple] Specially organized data storage to simplify its data analysis.
\end{description}

\section{Steps in making the report}

Here are the main steps in the process.

\begin{itemize}
\item Install {\bf CORAL}, patch it, compile it. 
\item Install {\bf PHAST}, patch it, compile it.
\item Prepare {\bf CORAL+PHAST} options file.
\item Run {\bf CORAL}+{\bf PHAST} and produce output root files.
\item Run script over the root files to create the final report.
\end{itemize}

\subsection{{\bf CORAL} installation}
\subsubsection{Install {\bf CORAL} source code}
Install {\bf CORAL} source files from {\bf CVS}.
\subsubsection{Increase the size of {\it TOpt::SmoothPos} container}
In the file {\it CORAL/src/track/traffic/includes/TOpt.h} change the line
\begin{verbatim}
static double  SmoothPos[10];
\end{verbatim}
to
\begin{verbatim}
static double  SmoothPos[300];
\end{verbatim}
and another line
\begin{verbatim}
double TOpt::SmoothPos[10];
\end{verbatim}
to
\begin{verbatim}
double TOpt::SmoothPos[300];
\end{verbatim}
This allows to calculate track parameters precisely at the position of
{\bf STDC} planes. Moreover, Albert's plots will not be filled without track
parameters calculated at the position of {\bf STDC} planes.
\subsubsection{Make it possible to analyse DriftChambers and W45 detectors as well}
These modifications are optional. If you apply the changes mentiond below you
will have an oppotunity to analysis other drift-type detectors.

You may copy the pieces of code sections mentioned below from
the source file \mbox{\it CORAL/src/geom/CsStrawTubesDetector.cc}.

In the two files
\begin{description}
\it
\item[] CORAL/src/geom/CsDriftChamberDetector.cc
\item[] CORAL/src/geom/CsDWDetector.cc
\end{description}
apply the following changes:
\begin{itemize}
\item Include the extra header file:
\begin{verbatim}
#include "Detectors/Detector.h"
\end{verbatim}
\item In the function {\it DecodeChipDigit(const CS::Chip::Digit \&digit)}
change the line
\begin{verbatim}
myDigits_.push_back( new CsDigit(*this,ch,&time,1) );
\end{verbatim}
to the following lines:
\begin{verbatim}
CS::ChipF1::DataID id(digit.GetDataID());

vector<double> data;
data.push_back(time);                // time in slices
data.push_back(d->GetChannelPos());  // channel position
data.push_back(d->GetTimeDecoded()); // time in [ns]
data.push_back(id.u.s.src_id);       // data source id
data.push_back(id.u.s.geoID_or_port);// card address
data.push_back(id.u.s.chip_chan);    // electronic channel

myDigits_.push_back( new CsDigit(*this, d->GetChannel(), 
                                  &data[0],data.size()));
\end{verbatim}

\item In the function {\it readCalibration(int timePoint)} at the very begining of it,
add the following code:
\begin{verbatim}
if( alt_detectors==NULL )
{
    // Create detector description from detectors.dat file
    alt_detectors = new CS::Detectors;
    alt_detectors->ReadDetectorsDAT(
                *CsInit::Instance()->getDetectorTable());
}

delete alt_det;
alt_det = NULL;

try
{
    alt_det = &alt_detectors->Find(GetTBName());
}
catch(...)
{
}
\end{verbatim}
\end{itemize}

\subsubsection{Fix CORAL bug}
In the file {\it CORAL/src/track/traffic/sources/TTrackGetSmoothed.cc}
find the code segment
\begin{verbatim}
if(!found){
  cout<<"TTrack::GetSmoothed(THlx&, double) ==> Can't find ...
  this->Print(0);
  this->Print(1);
  this->Print(2);
  this->Print(3);

  exit(1);
}
\end{verbatim}
and replace {\it exit(1);} to {\it return -1;}.

\subsubsection{CORAL compilation}
After these steps one can compile {\bf CORAL} with the standard procedure.

\subsection{{\bf PHAST} installation}
Install {\bf PHAST}, compile it. Go to the directory {\it PHAST/coral}.
And run the following command:
\begin{verbatim}
$ tar xjf /afs/cern.ch/compass/detector/straw\
/src/phast-coral-mod.tar.bz2
\end{verbatim}
This will extract the files needed for {\bf STDC} ntuples generation and
for filling the Albert's histograms.

One have to exclude from the compilation file {\it DstProdMon.cc}. This can be
achived by renaming this file to another one without the {\it .cc} extension,
for example:
\begin{verbatim}
$ mv DstProdMon.cc DstProdMon.cc.
\end{verbatim}

\subsection{CORAL option file}
Take the most recent version of an option file for {\bf CORAL+PHAST}.
It can be found in the {\it CORAL/src/user} directory.
\subsubsection{Activation of X-ray corrections}
To activate the X-ray corrections you have to add the line:
\begin{verbatim}
STRAW settings spacers=YES
\end{verbatim}

\subsubsection{Adding smoothing points at {\bf STDC} positions}
To be able to fill Albert's histogram one should add a set of smoothing points for tracking at the positions
of the {\bf STDC} (add {\bf DC} and {\bf W45} if you want to analyze them as well). It looks like this:
\begin{verbatim}
TraF SmoothPos [0-4]    534.3970  534.5725  534.3970  535.4130
TraF SmoothPos [5-9]    539.2375  539.4130  542.3970  542.5725
\end{verbatim}
The list of smooth points depends on the detectors-dat file. You can get the list of all smooth points
which you have to put inside your {\bf CORAL} option file with the aid of the following command:
\begin{verbatim}
cat detectors.dat | grep det | grep ST.....b | awk '{print $11}'
\end{verbatim}

\subsubsection{Clusters modification}
X-ray corrections are applied at the same time as signal propagation time is
corrected. But the original cluster's positions are not changed. So with the
standard option file {\it CORAL/pkopt/trafdic.YYYY.opt} with the line
\begin{verbatim}
TraF	ReMode	[29]	3
\end{verbatim}
you would not see any affect of applying X-ray corrections on cluster's positions.
You have to add the following
line in your {\bf CORAL} option file {\it after} an inclusion of {\it trafdic.YYYY.opt} file:
\begin{verbatim}
TraF	ReMode	[29]	7
\end{verbatim}

\subsubsection{Mini DST creation (optional)}
If you do not want to generate the mDST files, comment out the line
\begin{verbatim}
mDST    file            mDST.root
\end{verbatim}

\subsubsection{Extra histograms (optional)}
To fill some extra histograms, add this:
\begin{verbatim}
ST hist level high
\end{verbatim}

\subsection{Run CORAL}
This is not going to be easy. To make a report of an {\it absolute minimal} quality you
need to analyze about twenty thousands events. Having the {\bf CORAL} reconstruction
speed equal to approximately two events per second it leads to a three hours of
computations and two hundreds of megabytes output root file size. Your desktop computer
may stand this. But to make a good quality report
you will need to analyze one full run. This is about three hundreds times events
more. This can not be done on a single computer. You
have to use the CERN batch system and put your huge output files to {\bf CASTOR}.

The commands to run the jobs are here:
\begin{verbatim}
$ export CORAL="/path/to/coral"
$ export PHAST="/path/to/phast"
$ rfmkdir /castor/cern.ch/user/z/your_name/37059
$ cd $CORAL
$ . setup.sh
$ cd $PHAST/coral
$ /afs/cern.ch/compass/detector/straw/bin/cs lsf \
 --queue=1nd cs --coral --run=37059 --opt=trafdic.opt \
 --todir=/castor/cern.ch/user/z/your_name/37059 \
 $PWD/coral.exe
\end{verbatim}

\subsection{Combining the CORAL output files togerther}
\label{CORAL-merge}
The output files are located in directory
\begin{verbatim}
/castor/cern.ch/user/z/your_name/37059
\end{verbatim}
The next step is to merge them togerther. This can be done with the help of
{\it hadd.C} {\bf ROOT} script. The {\bf CORAL} exercise is finished once you merged the
files. Before merging them you may consider to copy the root files from {\bf CASTOR} to
your local hard disk (use the command {\it rfcp}).



\section{Making the report}
\subsection{Residuals versus channel}
Lets suppose that your output file name after {\bf CORAL} finished it work
has name {\it coral.root}. To create the report you have start root
and execute the following commands in it (it is assumed that the {\it PHAST}
environment variable is set):

\begin{verbatim}
$ root
[root] .L $PHAST/coral/residuals.C
[root] UMaps("/home2/zvyagin/37059-align/trafdic.root");
[root] CompStrawXray3D()
\end{verbatim}

After a couple of minutes you can quite from root. The residual plots
may be found in the file with name {\bf StrawXray-2003-Xray-0.ps}.

%%To create a global report you should run the following command:
%%\begin{verbatim}
%%$ root data.root 'report.C("","","out.root")'
%%\end{verbatim}

%%To create a report only for a specific detector, run the same script but
%%with the detector name as a first argument:
%%\begin{verbatim}
%%$ root data.root 'report.C("ST03X1db","","out.root")'
%%\end{verbatim}

%\section{Plots description}

%\subsection{{\bf CORAL} residuals and the Xray}

% \subsubsection{Plot: CORAL residuals and X-ray corrections for STx.}
% \begin{description}
% \item [left plot] Black points: Xray corrections at the detector center (obtained by
%         interpolation between the two spacers in the center). Red histogram:
%         CORAL residuals
%         obtained in the detector region $[-30cm,+30cm]$ (approximatelly between the two
%         central spacers). Green histogram: difference between black and red histograms.
%         The green histogram represents what residuals one could expect if the X-ray
%         corrections are applied. Black, red and green straight lines - result of a line
%         fit of an appropriate histogram. Non-horizontal red line indicates that pitch
%         size was calculated wrongly by the COMPASS alignment program.
% \item [right plots] For every histogram (black,red,green) it is plotted the
%         projection of a histogram points along the fit line on the left plot. The RMS
%         shows how big the spread of points is. The RMS of a green histogram indicates
%         what kind of residuals one could expect with a correct alignment and applied
%         X-ray corrections.
% \end{description}

\newpage
\appendix{This is appendix}
\section{Ntuple variables description}
\label{ntuple-variables}
This is the description of variables from an ntuples with the
name like {\it ST03X1db\_CORAL}.
\begin{description}
\item[x] X-coordinate in MRS of track interaction with the detector.
\item[y] Y-coordinate in MRS of track interaction with the detector.
\item[z] Z-coordinate in MRS of track interaction with the detector. It must be exactly the same
         for all entries of the same ntuple (the same detector).
\item[wx] X-coordinate in DRS of track interaction with the detector.
\item[wy] Y-coordinate in DRS of track interaction with the detector.
\item[wz] it should be always zero, by definition of the detector referense system (DRS).
\item[ax] track angle: $dx/dz$ ?
\item[ay] track angle: $dy/dz$ ?
\item[src] Catch source ID of the card which sent data.
\item[geo] Geographical address of the card which sent data.
\item[ech] Channel number of an electronic card which sent data.
\item[ch]  Detector channel number
\item[chp] Detector channel position (0,-1,+1)
\item[chx] Channel coordinate in DRS.
\item[t]   Time of the hit (no $T_0$ substraction).
\item[r]   Drift distance (RT is applied)
\item[d]   Distance between track and wire.
\item[ch2]    Detector channel number of the second layer with an associated hit
\item[t2]     Time of the associated hit
\item[r2]     Drift distance of the associated hit
\item[d2]     Residual of the associated hit
\item[cor\_sp]   X-ray correction (spacer correction) applied to this hit
\item[cor\_spt]  Signal propagation time correction applied to this hit
\item[tr\_Xi2] track's $\chi^2$
\item[tr\_X0]  track's accumulated radiation length
\item[tr\_t]   track's time
\item[tr\_res] track's resolution
\item[tr\_nh]  number of track hits
\item[tr\_q]   track's charge divided by momentum
\item[tr\_z1]  Z coordinate (MRS) of a first track's cluster
\item[tr\_z2]  Z coordinate (MRS) of a last track's cluster
\item[v1,v2,*] Additional varaibles.
\end{description}

New entry to a ntuple is added every time when a track crosses the detector surface.
If a {\bf STDC} hit corresponding to the track was not found then ntuple variable for
the channel number $ch=-1$. Other variables related to a {\bf STDC} hit informatin are
meaningles: {\it src,geo,ech,ch,chp,chx,t,r,ch2,t2,r2,d2}.


\section{How to make simple plots}
Let's consider that the output root file from {\bf CORAL} has name {\it coral.root}.
This file may be one of the files created by {\bf CORAL} or a result of the merge of all
your {\bf CORAL} output files, see Section \ref{CORAL-merge}. We start a {\bf ROOT} session
by running the following command from a command prompt:
\begin{verbatim}
$ root coral.root
\end{verbatim}
Once root has started you may type {\it .ls} to see the list of objects in your
{\it coral.root} file. Among those objects there are ntuples with the names like
{\it ST03X1db\_CORAL}. See Section \ref{ntuple-variables} for description of
variables in the ntuple. The list of all variables may be obtained by running the command
\begin{verbatim}
ST03X1db_CORAL.Show()
\end{verbatim}

To make a plot you shoud type something like this:
\begin{verbatim}
ST03X1db_CORAL.Draw("t:d","ch>=0")
\end{verbatim}
Which will plot two dimensional distribution of variable {\it t} versus variable {\it d}
with the events selection {\it ch>=0}.

\subsubsection{Simple plots}

\begin{description}
\item[$Draw("x:y","")$] Distribution of tracks which cross the detector, in MRS
\item[$Draw("wx:wy","")$] Distribution of tracks which cross the detector, in DRS
\item[$Draw("r:t","r>=0")$] RT-relation
\end{description}

%/afs/cern.ch/compass/detector/calibrations/tools/bin/

\end{document}
